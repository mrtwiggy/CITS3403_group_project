{% extends "base.html" %}

{% block title %}BobaBoard - Recent Reviews{% endblock %}

{% block content %}
<main class="flex-grow max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-3xl font-bold mb-8">Recent Reviews</h1>
    
    <!-- Review Filters -->
    <div class="bg-white p-4 rounded-lg shadow-md mb-8">
        <div class="flex flex-wrap gap-4 items-center">
            <!-- View Dropdown -->
            <select id="view-select" class="p-2 border rounded focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                <option value="public">üåç Public Reviews</option>
                <option value="friends">üë• Friends' Reviews</option>
            </select>

            <!-- Search Bar -->
            <div class="w-full md:w-auto flex-grow">
                <input type="text" 
                       id="review-search" 
                       placeholder="Search reviews..." 
                       class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-pink-500">
            </div>
            
            <select id="franchise-select" class="p-2 border rounded">
                <option value="">All Franchises</option>
                <option value="Boba Boba">Boba Boba</option>
                <option value="Bon Bon Cha">Bon Bon Cha</option>
                <option value="Chaffic">Chaffic</option>
                <option value="Chatime">Chatime</option>
                <option value="Gong Cha">Gong Cha</option>
                <option value="Gotcha Fresh Tea">Gotcha Fresh Tea</option>
                <option value="Mahci Machi">Mahci Machi</option>
                <option value="Once For All">Once For All</option>
                <option value="Milk Flower">Milk Flower</option>
                <option value="Presotea">Presotea</option>
                <option value="T4">T4</option>
                <option value="Teamorrow">Teamorrow</option>
                <option value="Utopia">Utopia</option>
            </select>
            <select id="location-select" class="p-2 border rounded" disabled>
                <option value="">Select Location</option>
            </select>
            <select id="rating-select" class="p-2 border rounded">
                <option value="">All Ratings</option>
                <option value="5">5 Boba Balls</option>
                <option value="4">4+ Boba Balls</option>
                <option value="3">3+ Boba Balls</option>
            </select>
            <select id="sort-select" class="p-2 border rounded">
                <option value="recent">Most Recent</option>
                <option value="rating">Highest Rated</option>
            </select>
        </div>
    </div>

    <!-- Reviews List -->
    <div class="space-y-6" id="reviews-container">
        <!-- Reviews will be populated by JavaScript -->
        <div class="text-center py-8 text-gray-500">Loading reviews...</div>
    </div>
    
    <!-- Load More Button -->
    <div id="load-more-container" class="mt-8 text-center hidden">
        <button id="load-more-btn" class="bg-pink-400 text-white py-2 px-6 rounded-full hover:bg-pink-500 transition duration-300">
            Load More Reviews
        </button>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const viewSelect = document.getElementById('view-select');
        const reviewsContainer = document.getElementById('reviews-container');
        const searchInput = document.getElementById('review-search');
        const franchiseSelect = document.getElementById('franchise-select');
        const locationSelect = document.getElementById('location-select');
        const ratingSelect = document.getElementById('rating-select');
        const sortSelect = document.getElementById('sort-select');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const loadMoreContainer = document.getElementById('load-more-container');
        
        let allReviews = [];
        let filteredReviews = [];
        let currentOffset = 0;
        let hasMoreReviews = false;
        const reviewsPerPage = 5;

        // Function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            // Less than 1 hour
            if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            }
            // Less than 1 day
            if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            }
            // Less than 7 days
            if (diff < 604800000) {
                const days = Math.floor(diff / 86400000);
                return `${days} day${days !== 1 ? 's' : ''} ago`;
            }
            // Otherwise show full date
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Function to render boba rating
        function renderRating(rating) {
            return 'üü§'.repeat(rating);
        }

        // Function to render a single review
        function renderReview(review) {
            const locationText = review.location && review.location.name 
                ? `${review.franchise.name} ‚Ä¢ ${review.location.name}`
                : review.franchise.name;

            return `
                <div class="bg-white p-6 rounded-lg shadow-md review-card ${review.is_private ? 'border-l-4 border-pink-400' : ''}" data-franchise="${review.franchise.name}" data-rating="${review.rating}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-3">
                            <img src="{{ url_for('static', filename='profile_pics/') }}${review.user.profile_pic}"
                                 alt="${review.user.username}"
                                 class="w-10 h-10 rounded-full">
                            <div>
                                <h3 class="text-xl font-semibold flex items-center">
                                    ${review.drink_name}
                                    ${review.is_private ? '<span class="ml-2 text-sm text-pink-600">üë• Friends Only</span>' : ''}
                                </h3>
                                <p class="text-gray-600">${locationText}</p>
                            </div>
                        </div>
                        <div class="text-3xl">${renderRating(review.rating)}</div>
                    </div>
                    <div class="mb-4">
                        <div class="text-gray-700">${review.review_content}</div>
                        <div class="mt-2 text-sm text-gray-500">
                            ${review.drink_size} ‚Ä¢ 
                            Sugar: ${review.sugar_level} ‚Ä¢ 
                            Ice: ${review.ice_level}
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-sm text-gray-500">
                        <span>Posted by ${review.user.username} ‚Ä¢ ${formatDate(review.uploaded_at)}</span>
                    </div>
                </div>
            `;
        }

        // Function to apply filters
        function applyFilters() {
            const searchText = searchInput.value.toLowerCase();
            const selectedFranchise = franchiseSelect.value;
            const selectedRating = parseInt(ratingSelect.value) || 0;
            const sortBy = sortSelect.value;
            
            filteredReviews = allReviews.filter(review => {
                const matchesSearch = review.review_content.toLowerCase().includes(searchText) ||
                                    review.drink_name.toLowerCase().includes(searchText) ||
                                    review.user.username.toLowerCase().includes(searchText);
                const matchesFranchise = !selectedFranchise || review.franchise.name === selectedFranchise;
                const matchesRating = !selectedRating || review.rating >= selectedRating;
                
                return matchesSearch && matchesFranchise && matchesRating;
            });
            
            // Sort reviews
            if (sortBy === 'rating') {
                filteredReviews.sort((a, b) => b.rating - a.rating);
            } else {
                filteredReviews.sort((a, b) => new Date(b.uploaded_at) - new Date(a.uploaded_at));
            }
            
            // Render filtered reviews
            reviewsContainer.innerHTML = filteredReviews.length > 0
                ? filteredReviews.map(renderReview).join('')
                : '<div class="text-center py-8 text-gray-500">No reviews found matching your filters.</div>';
                
            // Hide load more button when filtering
            loadMoreContainer.classList.add('hidden');
        }

        // Function to load reviews
        async function loadReviews(append = false) {
            if (!append) {
                reviewsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">Loading reviews...</div>';
                currentOffset = 0;
                allReviews = [];
            }
            
            try {
                const view = viewSelect.value === 'friends' ? 'true' : 'false';
                const response = await fetch(`/api/get_reviews?friends=${view}&offset=${currentOffset}&limit=${reviewsPerPage}`);
                if (!response.ok) throw new Error('Failed to load reviews');
                
                const data = await response.json();
                
                if (append) {
                    allReviews = [...allReviews, ...data.reviews];
                    const newReviewsHtml = data.reviews.map(renderReview).join('');
                    // Remove loading indicator if it exists
                    const loadingIndicator = reviewsContainer.querySelector('.text-center.py-8.text-gray-500');
                    if (loadingIndicator) {
                        reviewsContainer.removeChild(loadingIndicator);
                    }
                    // Append new reviews
                    reviewsContainer.innerHTML += newReviewsHtml;
                } else {
                    allReviews = data.reviews;
                    reviewsContainer.innerHTML = data.reviews.length > 0
                        ? data.reviews.map(renderReview).join('')
                        : '<div class="text-center py-8 text-gray-500">No reviews found.</div>';
                }
                
                // Update pagination state
                hasMoreReviews = data.has_more;
                currentOffset += data.reviews.length;
                
                // Show/hide load more button
                if (hasMoreReviews) {
                    loadMoreContainer.classList.remove('hidden');
                } else {
                    loadMoreContainer.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
                if (!append) {
                    reviewsContainer.innerHTML = '<div class="text-center py-8 text-red-500">Failed to load reviews. Please try again.</div>';
                }
            }
        }

        // Load more reviews
        loadMoreBtn.addEventListener('click', function() {
            loadReviews(true);
        });

        // Event listeners
        viewSelect.addEventListener('change', function() {
            loadReviews(false);
        });
        
        searchInput.addEventListener('input', applyFilters);
        franchiseSelect.addEventListener('change', applyFilters);
        ratingSelect.addEventListener('change', applyFilters);
        sortSelect.addEventListener('change', applyFilters);

        // Initialize the view
        loadReviews();
    });
</script>
{% endblock %} 