{% extends "base.html" %}

{% block title %}BobaBoard - Explore{% endblock %}

{% block content %}
<main class="w-full px-4 sm:px-6 lg:px-8">
    <div class="flex flex-col lg:flex-row gap-6">
        <!-- Left Sidebar -->
        <div class="w-full lg:w-80 flex-shrink-0">
            <!-- Search Section -->
            <div class="bg-white rounded-2xl shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Find Users</h3>
                <div class="relative">
                    <input type="text" 
                           id="user-search" 
                           placeholder="Search by username..." 
                           class="w-full p-2 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
                <div id="search-results" class="mt-4 space-y-2">
                    <!-- Search results will be populated here -->
                </div>
            </div>

            <!-- Trending Section -->
            <div class="bg-white rounded-2xl shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                <!-- Recent Reviews -->
                <div class="mb-6">
                    <h4 class="font-medium text-pink-600 mb-3">Latest Reviews</h4>
                    <div id="recent-reviews" class="space-y-4">
                        <!-- Recent reviews will be populated here -->
                    </div>
                </div>
                <!-- Most Active Users -->
                <div>
                    <h4 class="font-medium text-pink-600 mb-3">Most Active Users</h4>
                    <div id="active-users" class="space-y-3">
                        <!-- Active users will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="flex-grow">
            <div class="bg-white rounded-2xl shadow-md p-6">
                <!-- Leaderboard Header with Dropdown -->
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Boba Leaderboard</h2>
                    <select id="leaderboard-view" class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500">
                        <option value="public">Public Leaderboard</option>
                        <option value="friends">Friends Leaderboard</option>
                    </select>
                </div>

                <!-- Header Row -->
                <div class="grid grid-cols-12 gap-4 font-semibold mb-4 pb-2 border-b">
                    <div class="col-span-1 text-center">Rank</div>
                    <div class="col-span-3">User</div>
                    <div class="col-span-5">Favourite Store</div>
                    <div class="col-span-3 text-center">Total Bobas</div>
                </div>

                <!-- Leaderboard Content -->
                <div id="leaderboard-content" class="space-y-2">
                    <!-- Leaderboard entries will be populated here -->
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userSearch = document.getElementById('user-search');
    const searchResults = document.getElementById('search-results');
    const leaderboardView = document.getElementById('leaderboard-view');
    let searchTimeout;

    // User Search
    userSearch.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            searchResults.innerHTML = '';
            return;
        }

        searchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`/api/search_users?q=${encodeURIComponent(query)}`);
                const users = await response.json();
                
                searchResults.innerHTML = users.map(user => `
                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <img src="/static/profile_pics/${user.profile_pic}" 
                                 alt="${user.username}" 
                                 class="w-8 h-8 rounded-full mr-2">
                            <span class="text-sm">@${user.username}</span>
                        </div>
                        ${getFriendshipButton(user)}
                    </div>
                `).join('');

                // Add click handlers for friendship buttons
                document.querySelectorAll('.friendship-btn').forEach(btn => {
                    btn.addEventListener('click', handleFriendshipAction);
                });
            } catch (error) {
                console.error('Error searching users:', error);
            }
        }, 300);
    });

    // Friendship button helper
    function getFriendshipButton(user) {
        switch(user.friendship_status) {
            case 'accepted':
                return `<span class="text-sm text-green-600">Friends</span>`;
            case 'pending':
                return `<span class="text-sm text-gray-600">Requested</span>`;
            default:
                return `
                    <button class="friendship-btn bg-pink-100 text-pink-600 px-3 py-1 rounded text-sm hover:bg-pink-200"
                            data-user-id="${user.id}">
                        Add Friend
                    </button>
                `;
        }
    }

    // Handle friendship button clicks
    async function handleFriendshipAction(e) {
        const btn = e.target;
        const userId = btn.dataset.userId;
        
        try {
            const response = await fetch(`/friends/request/${userId}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                btn.outerHTML = '<span class="text-sm text-gray-600">Requested</span>';
            }
        } catch (error) {
            console.error('Error sending friend request:', error);
        }
    }

    // Load and display trending data
    async function loadTrendingData() {
        try {
            const response = await fetch('/api/trending_reviews');
            const data = await response.json();
            
            // Update recent reviews
            document.getElementById('recent-reviews').innerHTML = data.recent_reviews.map(review => `
                <div class="border-b pb-3 last:border-0 last:pb-0">
                    <div class="flex items-center mb-2">
                        <span class="font-medium">@${review.username}</span>
                        <span class="mx-2">Â·</span>
                        <span class="text-sm text-gray-500">${formatDate(review.uploaded_at)}</span>
                    </div>
                    <p class="text-sm text-gray-600">${review.drink_name} from ${review.franchise_name || 'Unknown'}</p>
                </div>
            `).join('');

            // Update active users
            document.getElementById('active-users').innerHTML = data.active_users.map(user => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <img src="/static/profile_pics/${user.profile_pic}" 
                             alt="${user.username}" 
                             class="w-8 h-8 rounded-full mr-2">
                        <span class="text-sm">@${user.username}</span>
                    </div>
                    <span class="text-sm text-gray-500">${user.review_count} reviews</span>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading trending data:', error);
        }
    }

    // Load and display leaderboard
    async function loadLeaderboard() {
        try {
            const view = leaderboardView.value;
            const response = await fetch(`/api/leaderboard?view=${view}`);
            const data = await response.json();
            
            document.getElementById('leaderboard-content').innerHTML = data.map(entry => `
                <div class="grid grid-cols-12 gap-4 items-center p-2 rounded-lg ${entry.is_current_user ? 'bg-pink-50 font-medium' : 'hover:bg-gray-50'}">
                    <div class="col-span-1 text-center">${entry.rank}</div>
                    <div class="col-span-3 flex items-center space-x-2 min-w-0">
                        <img src="/static/profile_pics/${entry.profile_pic}" 
                             alt="${entry.username}" 
                             class="w-8 h-8 rounded-full flex-shrink-0">
                        <span class="truncate">@${entry.username}</span>
                    </div>
                    <div class="col-span-5 truncate">${entry.favorite_franchise}</div>
                    <div class="col-span-3 text-center">${entry.total_reviews}</div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading leaderboard:', error);
        }
    }

    // Helper function to format dates
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
    }

    // Initial load
    loadTrendingData();
    loadLeaderboard();

    // Update leaderboard when view changes
    leaderboardView.addEventListener('change', loadLeaderboard);

    // Refresh data periodically
    setInterval(loadTrendingData, 60000); // Refresh trending data every minute
    setInterval(loadLeaderboard, 60000); // Refresh leaderboard every minute
});
</script>
{% endblock %} 