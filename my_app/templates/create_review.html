{% extends "base.html" %} 
 
{% block title %}BobaBoard - Reviews{% endblock %}

{% block content %}
<main class="w-full px-4 sm:px-6 lg:px-8">
    <!-- Upload Section -->
    <section class="bg-white p-6 rounded-2xl shadow-md mb-6 w-full">
      <h2 class="text-xl font-semibold mb-4">Upload Your Boba Review</h2>
      
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="mb-4 p-3 rounded {{ 'bg-green-100' if category == 'success' else 'bg-red-100' }}">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      
      <form class="grid gap-4" method="POST" action="{{ url_for('review.create_review') }}">
        {{ form.csrf_token }}
        
        <!-- Hidden fields to store button selections -->
        {{ form.sugar_level(id="sugar-level-hidden") }}
        {{ form.ice_level(id="ice-level-hidden") }}
        {{ form.rating(id="rating-hidden") }}
        
        <!-- Franchise Dropdown -->
        {{ form.franchise_id(id="franchise-select", class="border p-2 rounded") }}

        <!-- Location Dropdown -->
        {{ form.location_id(id="location-select", class="border p-2 rounded") }}

        <!-- Drink Name -->
        {{ form.drink_name(placeholder="Drink Name", class="border p-2 rounded") }}

        <!-- Size of Drinks -->
        <div class="grid grid-cols-3 gap-2">
          {% for subfield in form.drink_size %}
            <label class="flex items-center">
              {{ subfield(class="mr-2") }} {{ subfield.label.text }}
            </label>
          {% endfor %}
        </div>

        <!-- sugar levels -->
        <div>
          <label class="block mb-2 font-medium">Sugar Level (%):</label>
          <div class="flex gap-2 sugar-buttons">
            <button type="button" data-group="sugar" data-value="0%" class="bg-pink-100 hover:bg-pink-200 px-3 py-1 rounded">0%</button>
            <button type="button" data-group="sugar" data-value="25%" class="bg-pink-100 hover:bg-pink-200 px-3 py-1 rounded">25%</button>
            <button type="button" data-group="sugar" data-value="50%" class="bg-pink-100 hover:bg-pink-200 px-3 py-1 rounded">50%</button>
            <button type="button" data-group="sugar" data-value="75%" class="bg-pink-100 hover:bg-pink-200 px-3 py-1 rounded">75%</button>
            <button type="button" data-group="sugar" data-value="100%" class="bg-pink-100 hover:bg-pink-200 px-3 py-1 rounded">100%</button>
          </div>
        </div>

        <!-- ice levels -->
        <div>
          <label class="block mb-2 font-medium">Ice Level (%):</label>
          <div class="flex gap-2 ice-buttons">
            <button type="button" data-group="ice" data-value="0%" class="bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded">0%</button>
            <button type="button" data-group="ice" data-value="25%" class="bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded">25%</button>
            <button type="button" data-group="ice" data-value="50%" class="bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded">50%</button>
            <button type="button" data-group="ice" data-value="75%" class="bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded">75%</button>
            <button type="button" data-group="ice" data-value="100%" class="bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded">100%</button>
          </div>
        </div>

        <!-- written review -->
        {{ form.review_content(placeholder="Your Review...", class="border p-2 rounded", rows=4) }}

        <!-- boba rating (out of 5) -->
        <div>
          <label class="block font-medium mb-2">Taste Rating:</label>
          <div id="boba-rating" class="flex gap-1 text-3xl cursor-pointer">
            <span data-index="1">üîò</span>
            <span data-index="2">üîò</span>
            <span data-index="3">üîò</span>
            <span data-index="4">üîò</span>
            <span data-index="5">üîò</span>
          </div>
        </div>

        <!-- private/public review selector -->
        {{ form.is_private(id="privacy-hidden") }}
        <div>
          <label class="block font-medium mb-2">Review Privacy:</label>
          <select id="privacy-select" class="w-full p-2 border rounded focus:ring-2 focus:ring-pink-400 focus:border-pink-400">
            <option value="0">üåç Public - everyone can see this</option>
            <option value="1">üë• Private - only friends can see this</option>
          </select>
          <p class="text-sm text-gray-500 mt-1">Choose who can see your review.</p>
        </div>

        <!-- submit button -->
        {{ form.submit(class="bg-pink-400 text-white py-2 px-4 rounded hover:bg-pink-500") }}
      </form>
    </section>

    <!-- Recent Reviews Feed -->
     
  </main>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='/css/reviews.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='/js/reviews.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const franchiseSelect = document.getElementById('franchise-select');
    const locationSelect = document.getElementById('location-select');
    
    franchiseSelect.addEventListener('change', function() {
        const franchiseId = this.value;
        
        // Clear current options
        locationSelect.innerHTML = '<option value="0">Select Location</option>';
        
        // Don't fetch if "Select Franchise" is chosen (value 0)
        if (franchiseId == 0) {
            return;
        }
        
        // Fetch locations for selected franchise
        fetch(`/review/api/franchise/${franchiseId}/locations`)
            .then(response => response.json())
            .then(locations => {
                // Add locations to dropdown
                locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    option.textContent = location.name;
                    locationSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching locations:', error));
    });
    
    // Handle sugar level buttons
    const sugarLevelHidden = document.getElementById('sugar-level-hidden');
    document.querySelectorAll('.sugar-buttons button').forEach(button => {
      button.addEventListener('click', function() {
        // Clear active class from all buttons in group
        document.querySelectorAll('.sugar-buttons button').forEach(btn => {
          btn.classList.remove('bg-pink-300');
          btn.classList.add('bg-pink-100');
        });
        
        // Set active class on clicked button
        this.classList.remove('bg-pink-100');
        this.classList.add('bg-pink-300');
        
        // Update hidden field
        sugarLevelHidden.value = this.dataset.value;
      });
    });
    
    // Handle ice level buttons
    const iceLevelHidden = document.getElementById('ice-level-hidden');
    document.querySelectorAll('.ice-buttons button').forEach(button => {
      button.addEventListener('click', function() {
        // Clear active class from all buttons in group
        document.querySelectorAll('.ice-buttons button').forEach(btn => {
          btn.classList.remove('bg-blue-300');
          btn.classList.add('bg-blue-100');
        });
        
        // Set active class on clicked button
        this.classList.remove('bg-blue-100');
        this.classList.add('bg-blue-300');
        
        // Update hidden field
        iceLevelHidden.value = this.dataset.value;
      });
    });
    
    // Handle rating selection
    const ratingHidden = document.getElementById('rating-hidden');
    const bobaRating = document.getElementById('boba-rating');
    const ratingSymbols = {
      inactive: 'üîò',
      active: 'üü§'
    };

    // Handle privacy selection
    const privacyHidden = document.getElementById('privacy-hidden');
    const privacySelect = document.getElementById('privacy-select');
    
    // Set default to Public (0) if not already set
    if (!privacyHidden.value) {
      privacyHidden.value = '0';
      privacySelect.value = '0';
    } else {
      privacySelect.value = privacyHidden.value;
    }
    
    // Update hidden field when dropdown changes
    privacySelect.addEventListener('change', function() {
      privacyHidden.value = this.value;
    });
    
    bobaRating.querySelectorAll('span').forEach(star => {
      star.addEventListener('click', function() {
        const rating = parseInt(this.dataset.index);
        ratingHidden.value = rating;
        
        // Update visual display
        bobaRating.querySelectorAll('span').forEach(s => {
          const starIndex = parseInt(s.dataset.index);
          s.textContent = starIndex <= rating ? ratingSymbols.active : ratingSymbols.inactive;
        });
      });
      
      // Add hover effect
      star.addEventListener('mouseover', function() {
        const hoveredIndex = parseInt(this.dataset.index);
        bobaRating.querySelectorAll('span').forEach(s => {
          const starIndex = parseInt(s.dataset.index);
          if (starIndex <= hoveredIndex) {
            s.textContent = ratingSymbols.active;
          } else {
            s.textContent = ratingSymbols.inactive;
          }
        });
      });
    });
    
    // Reset stars on mouse out if no rating selected
    bobaRating.addEventListener('mouseout', function() {
      const currentRating = parseInt(ratingHidden.value) || 0;
      bobaRating.querySelectorAll('span').forEach(s => {
        const starIndex = parseInt(s.dataset.index);
        s.textContent = starIndex <= currentRating ? ratingSymbols.active : ratingSymbols.inactive;
      });
    });
  });
</script>
{% endblock %}